<h2 class="text-center my-5 display-6 fw-semibold text-primary">üìÉ ORDENES</h2>

<!-- Acciones superiores y Totales -->
<div class="d-flex justify-content-between align-items-center flex-wrap mb-4 gap-3 border-bottom pb-4">
    <!-- Botones de Acci√≥n -->
    <div class="d-flex flex-wrap gap-2">
        <button (click)="exportarPDF()" class="btn btn-outline-danger d-inline-flex align-items-center gap-1">
            <i class="bi bi-file-earmark-pdf-fill"></i> PDF
        </button>
        <button (click)="exportarExcel()" class="btn btn-outline-success d-inline-flex align-items-center gap-1">
            <i class="bi bi-file-earmark-excel-fill"></i> Excel
        </button>

        <div class="vr mx-1 d-none d-md-block"></div> <!-- Separador vertical -->

        <button (click)="getOnlyFinished()"
            class="btn btn-sm btn-outline-success d-inline-flex align-items-center gap-1">
            <i class="bi bi-check-circle"></i> Terminadas
        </button>
        <button (click)="getOnlyNotFinished()"
            class="btn btn-sm btn-outline-warning d-inline-flex align-items-center gap-1">
            <i class="bi bi-hourglass-split"></i> Pendientes
        </button>
        <button (click)="getAllOrders()" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1">
            <i class="bi bi-list-ul"></i> Todas
        </button>
    </div>

    <!-- Totales -->
    <div class="text-end ms-auto">
        <p class="mb-1 fw-bold text-secondary text-nowrap">
            TOTAL ORDENES: <span class="text-success">{{ totalOrders() }}</span>
        </p>
        <p class="mb-0 fw-bold text-secondary text-nowrap">
            DINERO TOTAL: <span class="text-success">{{ totalDineroDeOrdenes() }}</span>
        </p>
    </div>
</div>

<app-agregar-orden></app-agregar-orden>

<!-- Spinner -->
<div class="text-center my-4" *ngIf="SpinnerLoading">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<!-- Toolbar de Filtros Avanzados -->
<div class="container mb-4">
    <div class="card shadow-sm mb-4 border-0 bg-light">
        <div class="card-body">
            <h6 class="card-subtitle mb-3 text-muted fw-bold">üîç Filtros Avanzados</h6>
            <div class="row g-3">

                <!-- 1. Estado (API) -->
                <div class="col-12 col-md-3">
                    <label class="form-label small text-muted mb-1">Estado</label>
                    <select class="form-select form-select-sm" [(ngModel)]="filtroEstado" (change)="cambiarEstado()">
                        <option value="normal">Por defecto</option>
                        <option value="pendientes">Pendientes</option>
                        <option value="terminadas">Terminadas</option>
                        <option value="todas">Todas</option>
                    </select>
                </div>

                <!-- 2. Buscador -->
                <div class="col-12 col-md-5">
                    <label class="form-label small text-muted mb-1">Buscar (Cliente/Desc/Tel/ID)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="Escribe para buscar..."
                            [(ngModel)]="wordSearch">
                    </div>
                </div>

                <!-- 3. Rango de Fechas -->
                <div class="col-12 col-md-4">
                    <label class="form-label small text-muted mb-1">Rango de Fechas</label>
                    <div class="input-group input-group-sm">
                        <input type="date" class="form-control" [(ngModel)]="fechaInicio">
                        <span class="input-group-text">-</span>
                        <input type="date" class="form-control" [(ngModel)]="fechaFin">
                    </div>
                </div>

                <!-- 4. Rango de Precios -->
                <div class="col-12 col-md-4">
                    <label class="form-label small text-muted mb-1">Rango de Precio ($)</label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" placeholder="Min" [(ngModel)]="precioMin">
                        <span class="input-group-text">-</span>
                        <input type="number" class="form-control" placeholder="Max" [(ngModel)]="precioMax">
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Cards -->
<div class="container">
    <div class="row">
        <div class="col-lg-4 col-md-6 mb-4" *ngFor="let order of FilterOrders.slice().reverse()">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0 fw-semibold text-uppercase"> {{order.customerName}} </h5>
                </div>
                <div class="card-body text-center">
                    <ul class="list-unstyled text-start small mb-4">
                        <li><strong>ID:</strong> {{order.id}} </li>
                        <li>
                            <strong>STATUS: </strong>
                            <b [class.text-danger]="!order.finished" [class.text-success]="order.finished">
                                {{ order.finished ? 'TERMINADA' : 'NO TERMINADA' }}
                            </b>
                        </li>
                        <li><strong>FECHA DE ENTREGA:</strong> {{order.date | date: 'shortDate'}}</li>
                        <li><strong>DESCRIPCION:</strong> {{order.description}}</li>
                        <li><strong>NOMBRE DEL CLIENTE:</strong> {{order.customerName}}</li>
                        <li *ngIf="order.phoneNumber != 0"><strong>NUMERO DE TELEFONO:</strong> {{order.phoneNumber}}
                        </li>
                        <li *ngIf="order.phoneNumber == 0"><strong>NUMERO DE TELEFONO:</strong> Sin numero</li>
                        <li><strong>PRECIO:</strong> ${{order.price}}</li>
                    </ul>

                    <div class="d-grid gap-2">
                        <button *ngIf="!order.finished" type="button" class="btn btn-sm btn-outline-success"
                            (click)="FinishOrder(order.id)">‚úîÔ∏è Terminar</button>
                        <button *ngIf="order.finished" type="button" class="btn btn-sm btn-outline-success"
                            (click)="agregar_carrito(order.id , order.description ,order.price)">üõçÔ∏è Cobrar</button>
                        <button *ngIf="order.finished" type="button" class="btn btn-sm btn-outline-danger"
                            (click)="notFinishOrder(order.id)">‚¨ÖÔ∏è Dejar Pendiente</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                            (click)="modalEdit(order)" data-bs-target="#editmodal">‚úèÔ∏è Editar</button>
                        <button (click)="deleteOrder(order.id)" class="btn btn-outline-danger">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast de √©xito -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div #toastElement class="toast align-items-center text-white bg-success border-0" role="alert"
        aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                {{ toastMessage }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Modal para editar -->
<div class="modal fade" id="editmodal" tabindex="-1" aria-labelledby="formeditLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow-lg">
            <form [formGroup]="editOrder" (ngSubmit)="guardarEdit()">
                <div class="modal-header bg-primary text-white rounded-top-4">
                    <h5 class="modal-title" id="formeditLabel">‚úèÔ∏è EDITAR ORDEN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">FECHA </label>
                        <input type="date" class="form-control" required formControlName="date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DESCRIPCION</label>
                        <input type="text" class="form-control" formControlName="description" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NOMBRE DEL CLIENTE</label>
                        <input type="text" class="form-control" formControlName="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NUMERO DE TELEFONO</label>
                        <input type="number" class="form-control" formControlName="phoneNumber">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PRECIO</label>
                        <input type="number" class="form-control" formControlName="price" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill"
                        data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary rounded-pill" data-bs-dismiss="modal">Guardar
                        Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>