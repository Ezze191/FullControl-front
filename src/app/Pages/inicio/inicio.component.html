<!-- Toast de 칠xito -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
  <div #toastElement class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">

      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
        aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- TOP BAR BUTTONS -->
<div>
  <button class="btn btn-outline-success me-2 d-inline-flex align-items-center gap-1" (click)="mostrarcarrito()">
    <i class="bi bi-bag-fill"></i>
  </button>
  <button (click)="selectProducts()" class="btn btn-outline-success me-2 d-inline-flex align-items-center gap-1">
    PRODUCTOS
  </button>
  <button (click)="selectSeasonal()"
    class="btn btn-outline-warning text-dark me-2 d-inline-flex align-items-center gap-1">
    TEMPORADA
  </button>
  <button (click)="selectOfertas()" class="btn btn-outline-danger me-2 d-inline-flex align-items-center gap-1">
    OFERTAS
  </button>
  <button (click)="selectService()" class="btn btn-outline-success me-2 d-inline-flex align-items-center gap-1">
    SERVICIOS
  </button>
</div>

<!-- Sidebar Carrito -->
<div *ngIf="mostrarCarrito" class="position-fixed top-0 end-0 bg-white shadow-lg p-4 d-flex flex-column vh-100"
  style="width: 320px; max-width: 100%; overflow-y: auto; z-index: 1050;">

  <i class="bi bi-x-circle-fill" style="cursor:pointer" (click)="mostrarcarrito()"></i>

  <h5 class="fw-bold mb-4 border-bottom pb-2">LISTA DE PRODUCTOS</h5>

  <div *ngFor="let item of Carrito" class="mb-3 pb-2 border-bottom">
    <div class="fw-semibold">{{ item.nombre }}</div>
    <div *ngIf="item.type === 'seasonal'" class="badge bg-warning text-dark mb-1">Temporada</div>
    <div *ngIf="item.type === 'oferta'" class="badge bg-danger text-white mb-1">Oferta</div>

    <div class="d-flex align-items-center gap-2 my-2">
      <button class="btn btn-sm btn-outline-secondary" (click)="restarUnidad(item)" aria-label="Restar unidad">
        <i class="bi bi-dash"></i>
      </button>

      <span class="fw-bold flex-grow-1 text-center">{{ item.unidades }}</span>

      <button class="btn btn-sm btn-outline-secondary" (click)="sumarUnidad(item)" aria-label="Sumar unidad">
        <i class="bi bi-plus"></i>
      </button>
    </div>

    <div class="text-muted small">Precio: ${{ item.precio * item.unidades }}</div>
  </div>

  <div class="fw-bold fs-5 mt-auto pt-3 border-top">
    Total: ${{ calcularTotal() }}
  </div>

  <button class="btn btn-success w-100 fw-bold py-2 mt-3" (click)="abrirModal()" aria-label="Cobrar">
    <i class="bi bi-cash-coin me-2"></i> Cobrar
  </button>
</div>

<!-- Modal Cobrar Mejorado -->
<div class="modal fade" id="modalCobrar" tabindex="-1" aria-labelledby="modalCobrarLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-lg border-0">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title" id="modalCobrarLabel">
          <i class="bi bi-cash-stack me-2"></i> Cobrar
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body py-4 px-4">
        <p class="fs-5 mb-3">Total a pagar: <strong class="text-success">${{ calcularTotal() }}</strong></p>

        <label for="dineroIngresado" class="form-label fw-semibold">Dinero ingresado:</label>
        <input type="number" id="dineroIngresado" class="form-control form-control-lg text-center fs-5"
          [(ngModel)]="dineroIngresado" min="{{calcularTotal()}}" placeholder="Ingrese el monto" />

        <div *ngIf="dineroIngresado !== null && dineroIngresado >= calcularTotal()"
          class="alert alert-success mt-4 text-center py-2 fs-5 rounded-3">
          Cambio a dar: <strong>${{ dineroIngresado - calcularTotal() }}</strong>
        </div>

        <div *ngIf="dineroIngresado !== null && dineroIngresado < calcularTotal()"
          class="alert alert-danger mt-4 text-center py-2 fs-6 rounded-3">
          Dinero insuficiente
        </div>
      </div>
      <div class="modal-footer justify-content-between px-4 py-3">
        <button type="button" class="btn btn-primary fw-bold px-4 py-2 fs-6" [disabled]="!puedeCobrar()"
          (click)="confirmarCobrar()">
          Confirmar
        </button>
        <button type="button" class="btn btn-outline-secondary fw-semibold px-4 py-2" (click)="cerrarModal()">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<h2 class="text-center my-5 fw-bold text-primary display-5">游눳 COBRAR</h2>

<!-- SEARCH FORMS -->
<div *ngIf="ProductosActive || SeasonalActive || OfertasActive" class="container d-flex justify-content-center">
  <div class="bg-dark rounded-4 p-5 text-center shadow-lg" style="max-width: 566px; width: 100%;">
    <h2 class="text-white fw-bold mb-4">
      <span *ngIf="ProductosActive">Buscar Producto</span>
      <span *ngIf="SeasonalActive" class="text-warning">Buscar Temporada</span>
      <span *ngIf="OfertasActive" class="text-danger">Buscar Oferta</span>
    </h2>
    <form (submit)="findbyPLU()">
      <div class="mb-4">
        <input *ngIf="!findbyname" type="number" class="form-control text-center fw-bold py-3 fs-5"
          placeholder="C칩digo / PLU" [(ngModel)]="pluProducto" name="pluProducto" required>
        <input *ngIf="findbyname" type="text" class="form-control text-center fw-bold py-3 fs-5"
          placeholder="Nombre del Producto" [(ngModel)]="nombreProducto" name="pluProducto" required>
        <div class="form-check text-start mt-3">
          <input type="checkbox" class="form-check-input" id="buscarNombre" (change)="checkbox($event)">
          <label class="form-check-label text-white fw-bold" for="buscarNombre">Buscar Por Nombre</label>
        </div>
      </div>
      <div class="d-flex text-center justify-content-center gap-2">
        <button type="submit" class="btn btn-primary btn-lg fw-bold px-4 py-3 flex-grow-1">
          <i class="bi bi-search me-2"></i> Buscar
        </button>
        <button type="button" class="btn btn-warning btn-lg fw-bold px-4 py-3 flex-grow-1" (click)="toggleScanner()">
          <i class="bi bi-upc-scan me-2"></i> Escanear
        </button>
      </div>
    </form>
  </div>
</div>

<div *ngIf="ServiceActive" class="container d-flex justify-content-center">
  <div class="bg-dark rounded-4 p-5 text-center shadow-lg" style="max-width: 566px; width: 100%;">
    <h2 class="text-white fw-bold mb-4">Buscar Servicio</h2>
    <form (submit)="Servicesearchbyname()">
      <div class="mb-4">
        <input type="text" class="form-control text-center fw-bold py-3 fs-5" placeholder="Nombre del Servicio"
          [(ngModel)]="nombreService" name="nombreService" required>
      </div>
      <button class="btn btn-primary btn-lg fw-bold px-5 py-3">
        <i class="bi bi-search me-2"></i> Buscar
      </button>
    </form>
  </div>
</div>

<!-- RESULTS: PRODUCTO -->
<div class="row justify-content-center mt-5" *ngIf="producto && !findbyname">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-primary text-white text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ producto.NOMBRE }}</h5>
      </div>
      <div class="card-body text-center">
        <img [src]="producto.IMAGE_PATH" class="img-fluid rounded mb-3 border"
          style="max-height: 200px; object-fit: contain;" (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio:</strong> ${{ producto.PRECIO_VENTA }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2"
              [(ngModel)]="UnidadesAcobrar[producto.ID_PRODUCT]" required>
            <button class="btn btn-success w-100 fw-bold py-2"
              (click)="agregar_carrito(producto.ID_PRODUCT, producto.NOMBRE, producto.PRECIO_VENTA)">
              <i class="bi bi-cart-plus me-2"></i> Agregar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center mt-5" *ngFor="let prod of productosporname">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-primary text-white text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ prod.NOMBRE }}</h5>
      </div>
      <div class="card-body text-center">
        <img [src]="prod.IMAGE_PATH" class="img-fluid rounded mb-3 border"
          style="max-height: 200px; object-fit: contain;" (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio:</strong> ${{ prod.PRECIO_VENTA }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2"
              [(ngModel)]="UnidadesAcobrar[prod.ID_PRODUCT]" required>
            <button class="btn btn-success w-100 fw-bold py-2"
              (click)="agregar_carrito(prod.ID_PRODUCT, prod.NOMBRE, prod.PRECIO_VENTA)">
              <i class="bi bi-cart-plus me-2"></i> Agregar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RESULTS: SEASONAL -->
<div class="row justify-content-center mt-5" *ngIf="seasonalProducto && !findbyname">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-warning text-dark text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ seasonalProducto.NOMBRE }}</h5>
        <span class="badge bg-dark text-warning">Temporada: {{seasonalProducto.TEMPORADA}}</span>
      </div>
      <div class="card-body text-center">
        <img [src]="seasonalProducto.IMAGE_PATH" class="img-fluid rounded mb-3 border"
          style="max-height: 200px; object-fit: contain;" (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio:</strong> ${{ seasonalProducto.PRECIO_VENTA }}</li>
          <li><strong>Existencia:</strong> {{ seasonalProducto.EXISTENCIA }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2"
              [(ngModel)]="UnidadesAcobrar[seasonalProducto.ID_PRODUCT]" required>
            <button class="btn btn-warning w-100 fw-bold py-2"
              (click)="SeasonalAgregarCarrito(seasonalProducto.ID_PRODUCT, seasonalProducto.NOMBRE, seasonalProducto.PRECIO_VENTA)">
              <i class="bi bi-cart-plus me-2"></i> Agregar (Temp)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center mt-5" *ngFor="let s of seasonalPorName">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-warning text-dark text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ s.NOMBRE }}</h5>
      </div>
      <div class="card-body text-center">
        <img [src]="s.IMAGE_PATH" class="img-fluid rounded mb-3 border" style="max-height: 200px; object-fit: contain;"
          (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio:</strong> ${{ s.PRECIO_VENTA }}</li>
          <li><strong>Existencia:</strong> {{ s.EXISTENCIA }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2" [(ngModel)]="UnidadesAcobrar[s.ID_PRODUCT]"
              required>
            <button class="btn btn-warning w-100 fw-bold py-2"
              (click)="SeasonalAgregarCarrito(s.ID_PRODUCT, s.NOMBRE, s.PRECIO_VENTA)">
              <i class="bi bi-cart-plus me-2"></i> Agregar (Temp)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RESULTS: OFERTAS -->
<div class="row justify-content-center mt-5" *ngIf="ofertaProducto && !findbyname">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4 border-danger border-2">
      <div class="card-header bg-danger text-white text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ ofertaProducto.NOMBRE }}</h5>
        <span class="badge bg-white text-danger">OFERTA ESPECIAL</span>
      </div>
      <div class="card-body text-center">
        <img [src]="ofertaProducto.IMAGE_PATH" class="img-fluid rounded mb-3 border"
          style="max-height: 200px; object-fit: contain;" (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio Oferta:</strong> ${{ ofertaProducto.PRECIO }}</li>
          <li><strong>Existencia:</strong> {{ ofertaProducto.EXISTENCIA }}</li>
          <li><small class="text-muted">{{ ofertaProducto.DESCRIPCION }}</small></li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2 border-danger"
              [(ngModel)]="UnidadesAcobrar[ofertaProducto.ID_OFERTA]" required>
            <button class="btn btn-danger w-100 fw-bold py-2"
              (click)="OfertaAgregarCarrito(ofertaProducto.ID_OFERTA, ofertaProducto.NOMBRE, ofertaProducto.PRECIO)">
              <i class="bi bi-cart-plus me-2"></i> Agregar Oferta
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row justify-content-center mt-5" *ngFor="let o of ofertaPorName">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4 border-danger border-2">
      <div class="card-header bg-danger text-white text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ o.NOMBRE }}</h5>
        <span class="badge bg-white text-danger">OFERTA</span>
      </div>
      <div class="card-body text-center">
        <img [src]="o.IMAGE_PATH" class="img-fluid rounded mb-3 border" style="max-height: 200px; object-fit: contain;"
          (error)="onImageError($event)" />
        <ul class="list-unstyled text-start fs-6 mb-4">
          <li><strong>Precio Oferta:</strong> ${{ o.PRECIO }}</li>
          <li><strong>Existencia:</strong> {{ o.EXISTENCIA }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <input type="number" class="form-control mb-3 text-center py-2 border-danger"
              [(ngModel)]="UnidadesAcobrar[o.ID_OFERTA]" required>
            <button class="btn btn-danger w-100 fw-bold py-2"
              (click)="OfertaAgregarCarrito(o.ID_OFERTA, o.NOMBRE, o.PRECIO)">
              <i class="bi bi-cart-plus me-2"></i> Agregar Oferta
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- RESULTS: SERVICES -->
<div class="row justify-content-center mt-5" *ngFor="let service of services">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-header bg-primary text-white text-center rounded-top-4">
        <h5 class="mb-0 fw-bold text-uppercase fs-4">{{ service.name }}</h5>
      </div>
      <div class="card-body text-center">
        <ul class="list-unstyled text-center fs-6 mb-4">
          <li><strong>Precio:</strong> ${{ service.commission }}</li>
        </ul>
        <div class="row g-2">
          <div class="col-12">
            <button type="button" class="btn btn-success w-100 fw-bold py-2"
              (click)="agregar_servicio_carrito(service.id, service.name, service.commission)">
              <i class="bi bi-cart-plus me-2"></i> Agregar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scanner Overlay Global -->
<div *ngIf="mostrarScanner"
  style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center;">
  <div class="position-relative bg-white rounded-4 overflow-hidden shadow-lg" style="width: 90%; max-width: 500px;">

    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
      <h5 class="m-0 fw-bold"><i class="bi bi-upc-scan me-2"></i> Escanear C칩digo</h5>
      <button class="btn-close" (click)="toggleScanner()"></button>
    </div>

    <!-- Mensaje de espera (mientras hasPermission es null) -->
    <div class="p-3 bg-light" *ngIf="hasPermission === null && mostrarScanner && hasPermission !== true">
      <div class="alert alert-info mb-0 d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        <span>Iniciando c치mara...</span>
      </div>
    </div>

    <!-- Mensaje de permiso denegado -->
    <div class="p-3 bg-light" *ngIf="hasPermission === false && mostrarScanner">
      <div class="alert alert-warning mb-0">
        Por favor, permite el acceso a la c치mara para escanear.
      </div>
    </div>

    <!-- Mensaje de falta de dispositivos -->
    <div class="p-3 bg-light" *ngIf="hasPermission === true && !hasDevices && mostrarScanner">
      <div class="alert alert-danger mb-0">
        No se encontraron c치maras disponibles.
      </div>
    </div>

    <!-- Selector de c치mara si hay m치s de una -->
    <div class="p-2 bg-dark" *ngIf="availableDevices.length > 1">
      <select class="form-select form-select-sm" (change)="onDeviceSelectChange($any($event.target).value)">
        <option *ngFor="let device of availableDevices" [value]="device.deviceId"
          [selected]="currentDevice && device.deviceId === currentDevice.deviceId">
          {{device.label}}
        </option>
      </select>
    </div>

    <!-- El scanner debe estar presente para pedir permisos -->
    <div class="p-0 bg-dark position-relative" [class.d-none]="hasPermission === false">
      <zxing-scanner #scanner [enable]="scannerEnabled" [device]="currentDevice" (camerasFound)="onCamerasFound($event)"
        (permissionResponse)="onPermissionResponse($event)" (scanSuccess)="onCodeResult($event)"
        (scanError)="onScanError($event)"
        [formats]="['CODE_128', 'CODE_39', 'EAN_13', 'EAN_8', 'UPC_A', 'UPC_E', 'ITF', 'CODE_93']" [tryHarder]="true"
        [timeBetweenScans]="500" [delayBetweenScanAttempts]="500">
      </zxing-scanner>
      <!-- Gu칤as visuales tipo laser -->
      <div class="position-absolute top-50 start-0 w-100 border-top border-danger border-2 opacity-50"
        style="pointer-events: none;"></div>
    </div>

    <div class="p-3 text-center bg-light d-flex justify-content-between align-items-center">
      <small class="text-muted">Apunte la c치mara al c칩digo de barras</small>
      <button class="btn btn-sm btn-outline-secondary" (click)="reiniciarScanner()">
        <i class="bi bi-arrow-clockwise"></i> Reiniciar
      </button>
    </div>

  </div>
</div>